- builder:
    name: devstack-checkout
    builders:
      - shell: |
          #!/bin/bash -xe
          if true; then
              export DEVSTACK_GATE_3PPRJ_BASE=openstack-infra
              export DEVSTACK_GATE_3PBRANCH=master
          else
              export DEVSTACK_GATE_3PPRJ_BASE=<%= @devstack_gate_3pprj_base %>
              export DEVSTACK_GATE_3PBRANCH=<%= @devstack_gate_3pbranch %>
          fi
          if [[ ! -e devstack-gate ]]; then
              git clone -b $DEVSTACK_GATE_3PBRANCH https://github.com/${DEVSTACK_GATE_3PPRJ_BASE}/devstack-gate.git
          else
              cd devstack-gate
              git remote set-url origin https://github.com/${DEVSTACK_GATE_3PPRJ_BASE}/devstack-gate.git
              git remote update
              git reset --hard
              if ! git clean -x -f ; then
                  sleep 1
                  git clean -x -f
              fi
              git checkout $DEVSTACK_GATE_3PBRANCH
              git reset --hard remotes/origin/${DEVSTACK_GATE_3PBRANCH}
              if ! git clean -x -f ; then
                  sleep 1
                  git clean -x -f
              fi
              cd ..
          fi

- builder:
    name: prepare_testenv
    builders:
      - shell: |
          #!/bin/bash
          sudo rm -rf /opt/stack/new/screen-logs /opt/stack/new/devstacklog.txt* /opt/stack/new/devstack/localrc
          sudo rm -rf /opt/stack/new/tempest/etc/tempest.conf /opt/stack/new/tempest/.testrepository
          sudo rm -rf /opt/stack/new/tempest/tempest.log /opt/stack/new/tempest/nosetests*.xml
          sudo rm -rf /opt/stack/logs
          sudo rm -rf /opt/stack/confs
          sudo apt-get remove -y -qq python-crypto python-iso8601 python-netaddr python-cmd2
          sudo ovs-vsctl --if-exists del-br br-int
          sudo ovs-vsctl --if-exists del-br br-ex
          sudo ovs-vsctl --if-exists del-br br-tun
          sudo logrotate --force /etc/logrotate.conf
          exit 0

- builder:
    name: link-logs
    builders:
      - shell: |
          #!/bin/sh
          echo "Detailed logs: http://<%= @log_url_root %>/$LOG_PATH/"

- publisher:
    name: console-log
    publishers:
      - scp:
          site: '<%= @scp_name %>'
          files:
            - target: '$LOG_PATH'
              copy-console: true
              copy-after-failure: true

- publisher:
    name: devstack-logs
    publishers:
      - scp:
          site: '<%= @scp_name %>'
          files:
            - target: '$LOG_PATH'
              source: 'logs/**'
              keep-hierarchy: true
              copy-after-failure: true

- publisher:
    name: devstack-confs
    publishers:
      - scp:
          site: '<%= @scp_name %>'
          files:
            - target: '$LOG_PATH'
              source: 'confs/**'
              copy-after-failure: true
